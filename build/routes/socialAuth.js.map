{"version":3,"sources":["routes/socialAuth.js"],"names":["FacebookStrategy","passportFB","Strategy","GoogleStrategy","passportGG","OAuth2Strategy","router","express","Router","passport","use","configAuth","facebookAuth","accessToken","refreshToken","profile","done","logger","info","id","name","gender","emails","photos","length","userAccount","email","value","UserProfile","firstName","givenName","lastName","familyName","profileImg","LoginProvider","socialId","provider","userAccountDAO","findOrCreateSocial","rs","token","refToken","update","status","error","toString","googleAuth","get","authenticate","scope","failureRedirect","session","req","res","json","code","message","data","user","post","body"],"mappings":"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","file":"socialAuth.js","sourcesContent":["// @flow\n\nimport express from 'express';\nimport passport from 'passport';\nimport passportFB from 'passport-facebook';\nimport passportGG from 'passport-google-oauth';\nimport configAuth from '../config/auth';\nimport { userAccountDAO } from '../daos';\nimport { signJWT } from '../helper/jwt';\nimport logger from '../helper/logger';\n\nconst FacebookStrategy = passportFB.Strategy;\nconst GoogleStrategy = passportGG.OAuth2Strategy;\nconst router = express.Router();\n\npassport.use(new FacebookStrategy({\n\t...configAuth.facebookAuth\n}, async (accessToken, refreshToken, profile, done) => {\n\tlogger.info('Passport Facebook');\n\ttry {\n\t\tconst { id, name, gender, emails, photos } = profile;\n\n\t\tif (emails.length === 0) {\n\t\t\treturn done(null, false);\n\t\t}\n\n\t\tconst userAccount = {\n\t\t\temail: emails[0].value,\n\t\t\tUserProfile: {\n\t\t\t\tfirstName: name.givenName || null,\n\t\t\t\tlastName: name.familyName || null,\n\t\t\t\tgender: gender || null,\n\t\t\t\tprofileImg: photos[0] ? photos[0].value : null\n\t\t\t},\n\t\t\tLoginProvider: {\n\t\t\t\tsocialId: id,\n\t\t\t\taccessToken,\n\t\t\t\trefreshToken: refreshToken || null,\n\t\t\t\tprovider: 'facebook'\n\t\t\t}\n\t\t};\n\n\t\tconst rs = await userAccountDAO.findOrCreateSocial(userAccount, 'facebook');\n\t\tconst token = signJWT({\n\t\t\tid: rs[0].id,\n\t\t\tprovider: 'facebook'\n\t\t});\n\t\tconst refToken = signJWT({\n\t\t\tid: rs[0].id,\n\t\t\tprovider: 'facebook'\n\t\t}, '7d');\n\n\t\tawait rs[0].update({\n\t\t\ttoken,\n\t\t\tstatus: true\n\t\t});\n\n\t\treturn done(null, {\n\t\t\ttoken,\n\t\t\trefreshToken: refToken\n\t\t});\n\t} catch (error) {\n\t\tlogger.error(`Passport Facebook Error ${error.toString()}`);\n\t\treturn done(error);\n\t}\n}));\n\npassport.use(new GoogleStrategy({\n\t...configAuth.googleAuth\n}, async (accessToken, refreshToken, profile, done) => {\n\tlogger.info('Passport Google');\n\ttry {\n\t\tconst { id, name, gender, emails, photos } = profile;\n\n\t\tif (emails.length === 0) {\n\t\t\treturn done(null, false);\n\t\t}\n\n\t\tconst userAccount = {\n\t\t\temail: emails[0].value,\n\t\t\tUserProfile: {\n\t\t\t\tfirstName: name.givenName || null,\n\t\t\t\tlastName: name.familyName || null,\n\t\t\t\tgender: gender || null,\n\t\t\t\tprofileImg: photos[0] ? photos[0].value : null\n\t\t\t},\n\t\t\tLoginProvider: {\n\t\t\t\tsocialId: id,\n\t\t\t\taccessToken,\n\t\t\t\trefreshToken: refreshToken || null,\n\t\t\t\tprovider: 'google'\n\t\t\t}\n\t\t};\n\n\t\tconst rs = await userAccountDAO.findOrCreateSocial(userAccount, 'google');\n\t\tconst token = signJWT({\n\t\t\tid: rs[0].id,\n\t\t\tprovider: 'google'\n\t\t});\n\t\tconst refToken = signJWT({\n\t\t\tid: rs[0].id,\n\t\t\tprovider: 'google'\n\t\t});\n\n\t\tawait rs[0].update({\n\t\t\ttoken,\n\t\t\tstatus: true\n\t\t});\n\n\t\treturn done(null, {\n\t\t\ttoken,\n\t\t\trefreshToken: refToken\n\t\t});\n\t} catch (error) {\n\t\tlogger.error(`Passport Google ${error.toString()}`);\n\t\treturn done(error);\n\t}\n}));\n\nrouter.get('/facebook', passport.authenticate('facebook', {\n\tscope: ['public_profile', 'email', 'user_birthday']\n}));\n\nrouter.get('/facebook/callback', passport.authenticate('facebook', {\n\tfailureRedirect: '/auth/facebook/callback_error',\n\tsession: false\n}), (req: Request, res: Response) => {\n\tres.status(200).json({\n\t\tcode: 200,\n\t\terror: false,\n\t\tmessage: 'Login Successfully',\n\t\tdata: {\n\t\t\t...req.user\n\t\t}\n\t});\n});\n\nrouter.get('/facebook/callback_error', (req: Request, res: Response) => {\n\tlogger.error('Passport Facebook Callback Error');\n\tres.status(200).json({\n\t\tcode: 200,\n\t\terror: true,\n\t\tmessage: 'Login Failed'\n\t});\n});\n\nrouter.get('/google', passport.authenticate('google', {\n\tscope: ['profile', 'email']\n}));\n\nrouter.get('/google/callback', passport.authenticate('google', {\n\tfailureRedirect: '/auth/google/callback_error',\n\tsession: false\n}), (req: Request, res: Response) => {\n\tres.status(200).json({\n\t\tcode: 200,\n\t\terror: false,\n\t\tmessage: 'Login Successfully',\n\t\tdata: {\n\t\t\t...req.user\n\t\t}\n\t});\n});\n\nrouter.get('/google/callback_error', (req: Request, res: Response) => {\n\tlogger.error('Passport Google Callback Error');\n\tres.status(200).json({\n\t\tcode: 200,\n\t\terror: true,\n\t\tmessage: 'Login Failed'\n\t});\n});\n\nrouter.post('/profile', async (req: Request, res: Response) => {\n\tlogger.error('Profile Api Router: POST /profile');\n\ttry {\n\t\tconst userAccount = {\n\t\t\temail: req.body.email,\n\t\t\tUserProfile: {\n\t\t\t\tfirstName: req.body.firstName,\n\t\t\t\tlastName: req.body.lastName,\n\t\t\t\tgender: req.body.gender || null,\n\t\t\t\tprofileImg: req.body.profileImg\n\t\t\t},\n\t\t\tLoginProvider: {\n\t\t\t\tsocialId: req.body.id,\n\t\t\t\taccessToken: req.body.accessToken,\n\t\t\t\trefreshToken: req.body.refreshToken || null,\n\t\t\t\tprovider: req.body.provider\n\t\t\t}\n\t\t};\n\t\tconst rs = await userAccountDAO.findOrCreateSocial(userAccount, req.body.provider);\n\t\tconst token = signJWT({\n\t\t\tid: rs[0].id,\n\t\t\tprovider: req.body.provider\n\t\t});\n\t\tconst refToken = signJWT({\n\t\t\tid: rs[0].id,\n\t\t\tprovider: req.body.provider\n\t\t});\n\n\t\tawait rs[0].update({\n\t\t\ttoken,\n\t\t\trefreshToken: refToken\n\t\t});\n\t\treturn res.status(200).json({\n\t\t\tcode: 200,\n\t\t\terror: false,\n\t\t\tdata: {\n\t\t\t\ttoken,\n\t\t\t\trefreshToken: refToken\n\t\t\t}\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Profile Api Router: POST /profile');\n\t\treturn res.status(200).json({\n\t\t\tcode: 200,\n\t\t\terror: true,\n\t\t\tmessage: 'Can\\'t Save Profile'\n\t\t});\n\t}\n});\n\nexport default router;"]}